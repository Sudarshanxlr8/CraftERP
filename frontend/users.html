<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">ðŸ‘¥ User Management</h1>
            <div class="flex space-x-3">
                <button class="bg-green-600 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out flex items-center text-lg font-medium" onclick="openAddUserModal()">
                    <i class="bi bi-person-plus-fill mr-2"></i> Add User
                </button>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out flex items-center text-lg font-medium" onclick="refreshUsers()">
                    <i class="bi bi-arrow-clockwise mr-2"></i> Refresh
                </button>
            </div>
        </div>
        
        <div id="loading" class="flex justify-center items-center py-10" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>

        <div id="success-message" class="mt-4 p-4 text-lg text-green-800 bg-green-100 rounded-lg shadow-md" style="display: none;"></div>
        <div id="error-message" class="mt-4 p-4 text-lg text-red-800 bg-red-100 rounded-lg shadow-md" style="display: none;"></div>

        <div id="users-container" class="bg-white shadow-lg rounded-lg overflow-hidden" style="display: none;">
            <div class="overflow-x-auto">
                <table class="min-w-full text-base text-left text-gray-700 divide-y divide-gray-200">
                    <thead class="text-sm text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 font-semibold">ID</th>
                            <th scope="col" class="px-6 py-3 font-semibold">Username</th>
                            <th scope="col" class="px-6 py-3 font-semibold">Email</th>
                            <th scope="col" class="px-6 py-3 font-semibold">Role</th>
                            <th scope="col" class="px-6 py-3 font-semibold">Created At</th>
                            <th scope="col" class="px-6 py-3 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-users" class="p-6 text-center text-xl text-blue-800 bg-blue-50 rounded-b-lg" style="display: none;">
                No users found.
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50" style="display: none;">
        <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-xl shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h3 class="text-3xl font-bold text-gray-900">Add New User</h3>
                <button class="modal-close cursor-pointer z-50 text-gray-500 hover:text-gray-700" onclick="closeAddUserModal()">
                    <svg class="fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12l-4.89 4.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"></path>
                    </svg>
                </button>
            </div>
            <form id="addUserForm" class="space-y-6 py-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="role" name="role" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="Administrator">Administrator</option>
                        <option value="Manufacturing Manager">Manufacturing Manager</option>
                        <option value="Operator">Operator</option>
                        <option value="Inventory Manager">Inventory Manager</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="px-5 py-2.5 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-300 ease-in-out font-medium" onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 ease-in-out font-medium">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50" style="display: none;">
        <div class="relative p-8 bg-white w-full max-w-md mx-auto rounded-xl shadow-2xl">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Confirm Deletion</h3>
                <p class="text-gray-700 mb-6">Are you sure you want to delete this user? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancelDelete" class="px-5 py-2.5 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-300 ease-in-out font-medium">Cancel</button>
                    <button id="confirmDelete" class="px-5 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 ease-in-out font-medium">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        async function loadUsers() {
            const token = localStorage.getItem('token');
            if (!token) {
                showError('Please login to access this page');
                return;
            }

            try {
                showLoading();
                const response = await fetch('http://127.0.0.1:5000/api/users', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Unauthorized access. Please login as admin.');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error('Failed to fetch users');
                }

                const data = await response.json();
                displayUsers(data.users);
                
            } catch (error) {
                showError('Error loading users: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            const noUsersDiv = document.getElementById('no-users');
            const usersContainer = document.getElementById('users-container');
            
            if (!users || users.length === 0) {
                noUsersDiv.style.display = 'block';
                usersContainer.style.display = 'none';
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 text-sm font-semibold text-white rounded-full 
                            ${user.role === 'Administrator' ? 'bg-red-600' : 
                             user.role === 'Manufacturing Manager' ? 'bg-green-600' : 
                             user.role === 'Operator' ? 'bg-blue-600' : 
                             'bg-gray-600'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${user.created_at ? user.created_at.slice(0, 10) : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 transition duration-300 ease-in-out" onclick="confirmDeleteUser('${user.id}')">
                            <i class="bi bi-trash mr-1"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            noUsersDiv.style.display = 'none';
            usersContainer.style.display = 'block';
        }

        function refreshUsers() {
            loadUsers();
            showSuccess('User list refreshed!');
        }

        let userIdToDelete = null; // Variable to store the user ID to be deleted

        function confirmDeleteUser(userId) {
            userIdToDelete = userId;
            document.getElementById('deleteConfirmationModal').style.display = 'flex';
        }

        document.getElementById('cancelDelete').addEventListener('click', function() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
            userIdToDelete = null;
        });

        document.getElementById('confirmDelete').addEventListener('click', async function() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
            if (userIdToDelete) {
                await deleteUser(userIdToDelete);
                userIdToDelete = null;
            }
        });

        async function deleteUser(userId) {
            const token = localStorage.getItem('token');
            if (!token) {
                showError('Please login to perform this action');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`http://127.0.0.1:5000/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.message || 'Failed to delete user');
                }

                showSuccess('User deleted successfully!');
                loadUsers(); // Refresh the list
            } catch (error) {
                showError('Error deleting user: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset(); // Clear form fields
        }

        document.getElementById('addUserForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const userData = Object.fromEntries(formData.entries());

            const token = localStorage.getItem('token');
            if (!token) {
                showError('Please login to add a user');
                return;
            }

            try {
                showLoading();
                const response = await fetch('http://127.0.0.1:5000/api/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.message || 'Failed to add user');
                }

                showSuccess('User added successfully!');
                closeAddUserModal();
                loadUsers(); // Refresh the user list
            } catch (error) {
                showError('Error adding user: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        function showLoading() {
            document.getElementById('loading').style.display = 'flex'; // Changed to flex for centering
            document.getElementById('users-container').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('users-container').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }
    </script>
</body>
</html>