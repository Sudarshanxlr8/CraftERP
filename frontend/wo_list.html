<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Orders List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/auth.js"></script>
    <style>
        .filter-tab.active {
            background-color: #3b82f6;
            color: white;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Top comment for admin, manufacturing manager, and operator access -->
    <!-- Accessible by: Admin, Manufacturing Manager, Operator -->
    
    <!-- Navbar Container -->
    <div id="navbar-container"></div>
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Work Orders</h1>
                    <p class="text-gray-600">View and manage all assigned work orders</p>
                </div>
                <a href="/dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200 ease-in-out">
                    ‚Üê Back to Dashboard
                </a>
            </div>
            
            <!-- Progress Bar (Optional Feature) -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                    <span class="text-sm text-gray-500" id="progressText">Loading...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Filter Tabs (Optional Feature) -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="filterByStatus('all')" 
                        class="filter-tab active px-4 py-2 rounded-lg bg-blue-500 text-white transition duration-200 ease-in-out hover:bg-blue-600"
                        data-status="all">All</button>
                <button onclick="filterByStatus('not_started')" 
                        class="filter-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 transition duration-200 ease-in-out hover:bg-gray-300"
                        data-status="not_started">Not Started</button>
                <button onclick="filterByStatus('in_progress')" 
                        class="filter-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 transition duration-200 ease-in-out hover:bg-gray-300"
                        data-status="in_progress">In Progress</button>
                <button onclick="filterByStatus('paused')" 
                        class="filter-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 transition duration-200 ease-in-out hover:bg-gray-300"
                        data-status="paused">Paused</button>
                <button onclick="filterByStatus('completed')" 
                        class="filter-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 transition duration-200 ease-in-out hover:bg-gray-300"
                        data-status="completed">Completed</button>
            </div>
            
            <!-- Filters / Search Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">Search by Operator or Product</label>
                    <input type="text" id="searchInput" placeholder="Search by operator name or product..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                           onkeyup="filterTable()">
                </div>
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                    <select id="statusFilter" onchange="filterTable()" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out">
                        <option value="">All Status</option>
                        <option value="not_started">Not Started</option>
                        <option value="in_progress">In Progress</option>
                        <option value="paused">Paused</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Error Message Container -->
        <div id="errorContainer"></div>
        
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading work orders...</p>
            </div>
        </div>
        
        <!-- Main Table Section -->
        <div id="tableContainer" class="bg-white rounded-xl shadow-lg overflow-hidden" style="display: none;">
            <div class="overflow-x-auto">
                <table id="workOrdersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WO ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MO ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operation Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Center</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operator</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Planned Duration (hrs)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workOrdersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- No Results Message -->
            <div id="noResults" class="text-center py-8 text-gray-500" style="display: none;">
                <p>No work orders found.</p>
            </div>
        </div>
    </div>
    
    <!-- Edit Confirmation Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Edit</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Are you sure you want to edit this work order?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmEditBtn" class="px-4 py-2 bg-yellow-500 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300">
                        Edit
                    </button>
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-24 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load navbar first, then main scripts -->
    <script>
        // Global variables
        let workOrdersData = [];
        let currentEditId = null;
        
        // Load navbar
        fetch('/components/navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
            })
            .catch(error => console.error('Error loading navbar:', error));
        
        // Protect page access
        protectPage(pageRoles['/wo_list']);
        
        // Fetch work orders from API
        async function fetchWorkOrders() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch('/api/wo/all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                workOrdersData = data.work_orders || [];
                
                // Update UI
                updateProgressBar();
                populateTable(workOrdersData);
                
                // Show table, hide loading
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching work orders:', error);
                showError('Failed to load work orders. Please try again later.');
                document.getElementById('loadingState').style.display = 'none';
            }
        }
        
        // Update progress bar
        function updateProgressBar() {
            const completedCount = workOrdersData.filter(order => order.status === 'completed').length;
            const totalCount = workOrdersData.length;
            const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            document.getElementById('progressText').textContent = `${completedCount} / ${totalCount} completed`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }
        
        // Populate table with data
        function populateTable(data) {
            const tableBody = document.getElementById('workOrdersTableBody');
            const noResults = document.getElementById('noResults');
            
            if (data.length === 0) {
                tableBody.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            tableBody.innerHTML = data.map(order => {
                const productName = order.manufacturing_order?.bom?.product_name || 'Unknown';
                const operatorName = order.operator_name || 'Unassigned';
                const workCenter = order.work_center || 'N/A';
                const plannedDuration = order.planned_duration ? (order.planned_duration / 60).toFixed(1) : '0';
                
                const statusBadge = getStatusBadge(order.status);
                
                return `
                    <tr class="even:bg-gray-50 hover:bg-gray-100 transition duration-200 ease-in-out" 
                        data-status="${order.status}" 
                        data-operator="${operatorName.toLowerCase()}"
                        data-product="${productName.toLowerCase()}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.mo_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${productName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.operation_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${workCenter}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${operatorName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${plannedDuration}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <a href="/wo/${order.id}" 
                               class="inline-flex items-center px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition duration-200 ease-in-out">
                                View
                            </a>
                            <button onclick="confirmEdit(${order.id})" 
                                    class="inline-flex items-center px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded transition duration-200 ease-in-out">
                                Edit
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'not_started': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Not Started</span>',
                'in_progress': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">In Progress</span>',
                'paused': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Paused</span>',
                'completed': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Completed</span>'
            };
            
            return badges[status] || `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${status}</span>`;
        }
        
        // Table filtering functions
        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#workOrdersTable tbody tr');
            
            rows.forEach(row => {
                const operator = row.getAttribute('data-operator') || '';
                const product = row.getAttribute('data-product') || '';
                const status = row.getAttribute('data-status') || '';
                
                const matchesSearch = operator.includes(searchInput) || product.includes(searchInput);
                const matchesStatus = !statusFilter || status === statusFilter;
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Filter by status tabs
        function filterByStatus(status) {
            const rows = document.querySelectorAll('#workOrdersTable tbody tr');
            const tabs = document.querySelectorAll('.filter-tab');
            
            // Update tab styles
            tabs.forEach(tab => {
                if (tab.getAttribute('data-status') === status) {
                    tab.className = 'filter-tab active px-4 py-2 rounded-lg bg-blue-500 text-white transition duration-200 ease-in-out hover:bg-blue-600';
                } else {
                    tab.className = 'filter-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 transition duration-200 ease-in-out hover:bg-gray-300';
                }
            });
            
            // Filter rows
            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status') || '';
                if (status === 'all' || rowStatus === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Reset search and dropdown filters
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
        }
        
        // Edit confirmation modal functions
        function confirmEdit(id) {
            currentEditId = id;
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }
        
        // Handle edit confirmation
        document.getElementById('confirmEditBtn').addEventListener('click', function() {
            if (currentEditId) {
                window.location.href = `/wo/${currentEditId}/edit`;
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Show error message
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            fetchWorkOrders();
        });
    </script>
</body>
</html>